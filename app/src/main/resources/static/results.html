<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Resultados • CodeAnalyzer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <!-- Highlight.js para visualizar código -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css">
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/highlight.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/java.min.js"></script>
  <!-- ECharts para gráficos interativos -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.1/dist/echarts.min.js"></script>
  <style>
    .badge{border-radius:999px;padding:.25rem .6rem;font-size:.75rem;font-weight:600}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:.75rem}
    .soft{background:rgba(59,130,246,.08);border:1px dashed rgba(59,130,246,.35)}
    .scroll-y{max-height:22rem;overflow:auto}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:50}
    .modal.open{display:flex}
    pre code{white-space:pre; font-size:.85rem}
  </style>
</head>
<body class="bg-gray-50">
<div id="app" class="min-h-screen flex flex-col">
  <!-- Navbar -->
  <nav class="bg-blue-600 text-white shadow-lg">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center space-x-2">
        <i data-feather="code"></i>
        <span class="font-bold text-xl">CodeAnalyzer</span>
      </div>
      <div class="hidden md:flex space-x-6">
        <a class="hover:text-blue-200" href="index.html">Home</a>
        <a class="hover:text-blue-200" href="results.html">Resultados</a>
      </div>
      <button class="md:hidden">
        <i data-feather="menu"></i>
      </button>
    </div>
  </nav>

  <!-- Main -->
  <main class="flex-grow container mx-auto px-4 py-8">
    <div class="flex items-start justify-between gap-4 flex-wrap mb-6">
      <div>
        <h1 class="text-3xl font-bold text-gray-800">Resultados da análise</h1>
        <p class="text-gray-600">Testes gerados a partir de <b>entrada-usuario</b>, explicações e dashboards interativos.</p>
      </div>
      <div class="flex gap-2 items-center">
        <span id="chipRun" class="badge bg-blue-50 text-blue-700 border border-blue-200">run: —</span>
        <span id="chipStatus" class="badge bg-yellow-50 text-yellow-700 border border-yellow-200">status: —</span>
      </div>
    </div>

    <div class="grid md:grid-cols-3 gap-6 mb-6">
      <!-- Arquivos + KPIs -->
      <div class="card p-4 md:col-span-2" data-aos="fade-up">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold text-gray-800 flex items-center">
            <i data-feather="file-text" class="mr-2"></i> Arquivos de Teste
          </h2>
          <div class="flex gap-2">
            <button id="btnReload" class="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md text-sm">Recarregar</button>
            <a href="index.html" class="px-3 py-2 bg-white border border-gray-300 hover:bg-gray-50 rounded-md text-sm text-gray-700">Nova análise</a>
          </div>
        </div>

        <div class="grid grid-cols-3 gap-3 mb-4">
          <div class="soft rounded-md p-3">
            <div class="text-xs text-blue-700/80">Testes</div>
            <div id="kpiTestes" class="text-2xl font-bold text-blue-700">0</div>
          </div>
          <div class="soft rounded-md p-3">
            <div class="text-xs text-blue-700/80">Arquivos</div>
            <div id="kpiArquivos" class="text-2xl font-bold text-blue-700">0</div>
          </div>
          <div class="soft rounded-md p-3">
            <div class="text-xs text-blue-700/80">Cobertura</div>
            <div id="kpiCobertura" class="text-2xl font-bold text-blue-700">—</div>
          </div>
        </div>

        <div id="listaArquivos" class="scroll-y space-y-2">
          <div class="p-4 border border-dashed border-gray-300 rounded-md bg-gray-50 text-gray-500">
            Carregando arquivos…
          </div>
        </div>
      </div>

      <!-- Codecov + gráficos -->
      <div class="card p-4" data-aos="fade-up" data-aos-delay="100">
        <h2 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
          <i data-feather="pie-chart" class="mr-2"></i> Codecov & Gráficos
        </h2>

        <!-- Badge e links -->
        <div class="flex items-center gap-3 mb-3">
          <img id="badgeCodecov" alt="Codecov" class="h-6" />
          <a id="ccProject" target="_blank" class="text-blue-600 hover:underline text-sm">Projeto</a>
          <a id="ccCommits" target="_blank" class="text-blue-600 hover:underline text-sm">Commits</a>
        </div>

        <!-- Charts -->
        <div class="space-y-3">
          <div id="chartPie" class="w-full h-56 border rounded-md"></div>
          <div id="chartTreemap" class="w-full h-56 border rounded-md"></div>
        </div>

        <p class="text-xs text-gray-500 mt-3">Se o repositório for privado, faça login no Codecov em outra aba.</p>
      </div>
    </div>

    <!-- Explicações -->
    <div class="card p-4" data-aos="fade-up">
      <h2 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
        <i data-feather="info" class="mr-2"></i> Explicações
      </h2>
      <div id="listaExplicacoes" class="grid gap-3">
        <div class="p-4 border border-dashed border-gray-300 rounded-md bg-gray-50 text-gray-500">Carregando explicações…</div>
      </div>
    </div>

    <div id="statusBox" class="hidden mt-6 p-3 rounded-md text-sm"></div>
  </main>

  <footer class="bg-gray-800 text-white py-6">
    <div class="container mx-auto px-4 text-center">
      <p>&copy; 2023 CodeAnalyzer. Todos os direitos reservados.</p>
    </div>
  </footer>
</div>

<!-- Modal de código -->
<div id="codeModal" class="modal">
  <div class="bg-white rounded-xl shadow-xl w-[95vw] max-w-4xl max-h-[85vh] overflow-hidden">
    <div class="flex items-center justify-between border-b px-4 py-3">
      <div class="font-semibold text-gray-800" id="codeTitle">Arquivo</div>
      <button id="btnCloseModal" class="px-3 py-1.5 rounded-md border text-sm text-gray-700 bg-white hover:bg-gray-50">Fechar</button>
    </div>
    <div class="p-0 overflow-auto" style="max-height: calc(85vh - 52px);">
      <pre class="m-0"><code id="codeBlock" class="language-java"></code></pre>
    </div>
  </div>
</div>

<!-- <script>
AOS.init();
feather.replace();
hljs.registerLanguage('java', window.hljsDefineJava);

// ====== CONFIG DO SEU REPO (ajuste se necessário) ======
const OWNER  = 'lipesanfelice';
const REPO   = 'workflows';
const BRANCH = 'main';

// Caminhos-base
const GH_PATH_TESTS   = 'app/entrada-usuario/testes_explicações/tests';
const GH_PATH_EXPL    = 'app/entrada-usuario/testes_explicações/explicacoes';
const JACOCO_XML      = 'app/entrada-usuario/jacoco-relatorio/jacoco.xml';

const GITHUB_API = 'https://api.github.com';
const RAW_BASE   = `https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}`;

// ====== Token RUN para reset/bust cache por rodada ======
const qs = new URLSearchParams(location.search);
let RUN = qs.get('run')
        || (()=>{ try{return sessionStorage.getItem('lastRun')}catch(_){return null} })()
        || Date.now().toString();
try { sessionStorage.setItem('lastRun', RUN); } catch(_) {}

window.addEventListener('pageshow', (e) => { if (e.persisted) location.reload(); });

function noCache(url){
  const sep = url.includes('?') ? '&' : '?';
  return `${url}${sep}t=${encodeURIComponent(RUN)}`;
}

// ====== UI refs ======
const chipRun        = document.getElementById('chipRun');
const chipStatus     = document.getElementById('chipStatus');
const kpiTestes      = document.getElementById('kpiTestes');
const kpiArquivos    = document.getElementById('kpiArquivos');
const kpiCobertura   = document.getElementById('kpiCobertura');
const listaArquivos  = document.getElementById('listaArquivos');
const listaExplicacoes = document.getElementById('listaExplicacoes');
const statusBox      = document.getElementById('statusBox');
const btnReload      = document.getElementById('btnReload');

// Code modal
const codeModal   = document.getElementById('codeModal');
const codeTitle   = document.getElementById('codeTitle');
const codeBlock   = document.getElementById('codeBlock');
const btnCloseModal = document.getElementById('btnCloseModal');
btnCloseModal.addEventListener('click', ()=> codeModal.classList.remove('open'));
codeModal.addEventListener('click', (e)=>{ if(e.target===codeModal) codeModal.classList.remove('open'); });

// Charts
let chartPie, chartTreemap;

// ====== Helpers ======
function escreveStatus(msg, tipo='info'){
  statusBox.classList.remove('hidden','bg-green-100','text-green-800','border-green-200','bg-red-100','text-red-800','border-red-200','bg-blue-50','text-blue-800','border-blue-200');
  statusBox.classList.add('border','bg-blue-50','text-blue-800','border-blue-200');
  if (tipo==='ok'){ statusBox.classList.remove('bg-blue-50','text-blue-800','border-blue-200'); statusBox.classList.add('bg-green-100','text-green-800','border-green-200'); }
  if (tipo==='err'){ statusBox.classList.remove('bg-blue-50','text-blue-800','border-blue-200'); statusBox.classList.add('bg-red-100','text-red-800','border-red-200'); }
  statusBox.textContent = msg;
}
function limpar(el){ while(el.firstChild) el.removeChild(el.firstChild); }
function pick(arr){ return Array.isArray(arr) ? arr : []; }

// ====== Reset UI por rodada ======
function resetUI(){
  chipRun.textContent = 'run: ' + RUN;
  chipStatus.textContent = 'status: carregando…';
  chipStatus.className = 'badge bg-yellow-50 text-yellow-700 border border-yellow-200';

  kpiTestes.textContent = '0';
  kpiArquivos.textContent = '0';
  kpiCobertura.textContent = '—';

  listaArquivos.innerHTML = `
    <div class="p-4 border border-dashed border-gray-300 rounded-md bg-gray-50 text-gray-500">
      Carregando arquivos…
    </div>`;
  listaExplicacoes.innerHTML = `
    <div class="p-4 border border-dashed border-gray-300 rounded-md bg-gray-50 text-gray-500">
      Carregando explicações…
    </div>`;

  try { chartPie?.dispose(); } catch(_) {}
  try { chartTreemap?.dispose(); } catch(_) {}
  chartPie = echarts.init(document.getElementById('chartPie'));
  chartTreemap = echarts.init(document.getElementById('chartTreemap'));

  // Codecov links/badge (com no-cache)
  const badge = document.getElementById('badgeCodecov');
  const proj  = document.getElementById('ccProject');
  const commits = document.getElementById('ccCommits');
  badge.src = noCache(`https://codecov.io/gh/${OWNER}/${REPO}/branch/${BRANCH}/graph/badge.svg`);
  proj.href = `https://app.codecov.io/gh/${OWNER}/${REPO}/tree/${BRANCH}`;
  commits.href = `https://app.codecov.io/gh/${OWNER}/${REPO}/commits`;
}

// ====== GitHub API ======
async function listGithubPath(path){
  const base = `${GITHUB_API}/repos/${OWNER}/${REPO}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(BRANCH)}`;
  const r = await fetch(noCache(base), { cache:'no-store' });
  if (r.status === 404) return [];
  if (!r.ok) throw new Error('HTTP '+r.status+' ao listar '+path);
  const j = await r.json();
  if (Array.isArray(j)) {
    const files=[];
    for (const item of j) {
      if (item.type === 'file') files.push(item);
      if (item.type === 'dir') {
        const deeper = await listGithubPath(item.path);
        files.push(...deeper);
      }
    }
    return files;
  } else if (j && j.type === 'file') {
    return [j];
  }
  return [];
}
async function fetchRawText(path){
  const r = await fetch(noCache(`${RAW_BASE}/${path}`), { cache:'no-store' });
  if (!r.ok) throw new Error('HTTP '+r.status+' em '+path);
  return r.text();
}

// ====== Render de itens ======
function itemArquivoView(btnText, onClick){
  const a = document.createElement('button');
  a.type='button';
  a.className='px-3 py-1 rounded-md border text-sm text-gray-700 bg-white hover:bg-gray-50';
  a.textContent=btnText;
  a.addEventListener('click', onClick);
  return a;
}
function itemArquivo(a){
  const nome = a.name || a.path || 'arquivo';
  const el = document.createElement('div');
  el.className = 'p-3 border rounded-md flex items-center justify-between gap-3';
  const left = document.createElement('div');
  left.className = 'flex items-center gap-2';
  const ic = document.createElement('i');
  ic.setAttribute('data-feather','file'); ic.className = 'text-gray-400';
  const span = document.createElement('span');
  span.className = 'font-medium text-gray-800 break-all';
  span.textContent = nome;
  left.appendChild(ic); left.appendChild(span);

  const right = document.createElement('div');
  right.className = 'flex gap-2';
  const btnOpen = itemArquivoView('Ver código', async ()=>{
    try{
      const code = await fetchRawText(a.path);
      codeTitle.textContent = nome;
      codeBlock.textContent = code;
      hljs.highlightElement(codeBlock);
      codeModal.classList.add('open');
    }catch(e){
      escreveStatus('Falha ao abrir código: '+e.message,'err');
    }
  });
  const linkRaw = document.createElement('a');
  linkRaw.href = noCache(`${RAW_BASE}/${a.path}`); linkRaw.target='_blank';
  linkRaw.className='px-3 py-1 rounded-md border text-sm text-gray-700 bg-white hover:bg-gray-50';
  linkRaw.textContent='Abrir RAW';

  right.appendChild(btnOpen);
  right.appendChild(linkRaw);
  el.appendChild(left); el.appendChild(right);
  return el;
}
function itemExplicacao(e){
  const el = document.createElement('div');
  el.className = 'p-4 border rounded-md bg-white';
  const h = document.createElement('div');
  h.className = 'font-semibold text-gray-800 mb-1';
  h.textContent = e.title || e.name || 'Explicação';
  const p = document.createElement('div');
  p.className = 'text-gray-700 text-sm whitespace-pre-wrap';
  p.textContent = e.text || '';
  el.appendChild(h); el.appendChild(p);
  return el;
}

// ====== Carregadores ======
async function carregarArquivos(){
  const files = await listGithubPath(GH_PATH_TESTS);
  const javaFiles = files.filter(f=> (f.name||'').toLowerCase().endsWith('.java'))
                         .map(f=> ({ name:f.name, path:f.path }));
  limpar(listaArquivos);
  if (!javaFiles.length){
    const d = document.createElement('div');
    d.className='p-4 border border-dashed border-gray-300 rounded-md bg-gray-50 text-gray-500';
    d.textContent='Nenhum teste encontrado.';
    listaArquivos.appendChild(d);
  } else {
    javaFiles.forEach(a=> listaArquivos.appendChild(itemArquivo(a)));
    feather.replace();
  }
  kpiTestes.textContent = String(javaFiles.length);
  kpiArquivos.textContent = String(javaFiles.length);
}

async function carregarExplicacoes(){
  const files = await listGithubPath(GH_PATH_EXPL);
  const txtLike = files.filter(f=>{
    const n=(f.name||'').toLowerCase();
    return n.endsWith('.md')||n.endsWith('.txt');
  });
  limpar(listaExplicacoes);
  if (!txtLike.length){
    const d = document.createElement('div');
    d.className = 'p-4 border border-dashed border-gray-300 rounded-md bg-gray-50 text-gray-500';
    d.textContent='Sem explicações disponíveis';
    listaExplicacoes.appendChild(d);
  } else {
    for (const f of txtLike){
      const text = await fetchRawText(f.path);
      listaExplicacoes.appendChild(itemExplicacao({ title:f.name, text }));
    }
  }
}

function parseJacoco(xml){
  // parsing simples via regex — suficiente para KPIs e gráficos
  const pkgRe = /<package name="([^"]+)">([\s\S]*?)<\/package>/g;
  const srcRe = /<sourcefile name="([^"]+)">([\s\S]*?)<\/sourcefile>/g;
  const cntRe = /<counter type="([A-Z]+)" missed="(\d+)" covered="(\d+)"/g;

  const data = [];
  let m;
  while ((m = pkgRe.exec(xml))) {
    const pkg = m[1]; const body = m[2];
    let src; const files=[];
    while ((src = srcRe.exec(body))) {
      const fname = src[1]; const sbody = src[2];
      const counters = {};
      let c; while ((c = cntRe.exec(sbody))) {
        counters[c[1]] = { missed: +c[2], covered:+c[3] };
      }
      files.push({ name: fname, counters });
    }
    data.push({ pkg, files });
  }

  function sum(arr, path){
    return arr.reduce((acc, it)=> acc + path(it), 0);
  }
  // calcula cobertura de linhas global
  const lineCovered = sum(data.flatMap(p=>p.files), f => (f.counters.LINE?.covered)||0);
  const lineMissed  = sum(data.flatMap(p=>p.files), f => (f.counters.LINE?.missed)||0);
  const total = lineCovered + lineMissed;
  const percent = total>0 ? (lineCovered*100/total) : null;

  return { data, lineCovered, lineMissed, total, percent };
}

function renderCharts(jc){
  // pizza: covered vs missed
  const pieOpt = {
    tooltip: { trigger:'item' },
    legend: { bottom: 0 },
    series: [{
      type:'pie',
      radius: ['40%','70%'],
      avoidLabelOverlap: false,
      itemStyle:{ borderRadius:8, borderColor:'#fff', borderWidth:2 },
      label: { show:false },
      emphasis:{ label:{ show:true, fontSize:14, fontWeight:'bold' } },
      data:[
        { value: jc.lineCovered, name:'Cobertas' },
        { value: jc.lineMissed,  name:'Não cobertas' },
      ]
    }]
  };
  chartPie.setOption(pieOpt);

  // treemap por pacote/arquivo usando % de linhas cobertas
  const children = jc.data.map(p => {
    const files = p.files.map(f=>{
      const cov = f.counters.LINE || {missed:0,covered:0};
      const total = cov.covered + cov.missed;
      const pct = total>0 ? (cov.covered*100/total) : 0;
      return { name: f.name, value: Math.max(1,total), label:{ formatter:`${f.name}\n${pct.toFixed(1)}%` } };
    });
    const tot = files.reduce((a,b)=>a+b.value,0);
    return { name: p.pkg || '(default)', value: Math.max(1,tot), children: files };
  });

  const treemapOpt = {
    tooltip:{ formatter: (p)=> `${p.name}: ${p.value} linhas` },
    series:[{
      type:'treemap',
      roam:true,
      nodeClick:'zoomToNode',
      breadcrumb:{ show:true },
      label:{ show:true },
      data: children
    }]
  };
  chartTreemap.setOption(treemapOpt);
}

async function carregarJacoco(){
  try{
    const xml = await fetchRawText(JACOCO_XML);
    const jc = parseJacoco(xml);
    const cov = jc.percent!=null ? `${jc.percent.toFixed(2)}%` : '—';
    kpiCobertura.textContent = cov;

    renderCharts(jc);

    chipStatus.textContent = 'status: pronto';
    chipStatus.className = 'badge bg-green-100 text-green-700 border border-green-200';
  }catch(e){
    // Sem jacoco.xml ainda — mantém status informativo
    chipStatus.textContent = 'status: sem jacoco.xml';
    chipStatus.className = 'badge bg-yellow-50 text-yellow-700 border border-yellow-200';
  }
}

// ====== Boot ======
btnReload.addEventListener('click', async ()=>{
  // se quiser trocar o token a cada recarregar, descomente:
  // RUN = Date.now().toString();
  resetUI();
  escreveStatus('Atualizando…');
  await Promise.all([carregarArquivos(), carregarExplicacoes(), carregarJacoco()]);
  escreveStatus('Resultados atualizados', 'ok');
});

document.addEventListener('DOMContentLoaded', async ()=>{
  resetUI();
  await Promise.all([carregarArquivos(), carregarExplicacoes(), carregarJacoco()]);
  escreveStatus('Resultados carregados', 'ok');
});
</script> -->

<script>
  AOS.init();
  feather.replace();

  // ===== Marca única desta execução (passada pelo loading: results.html?status=...&t=12345) =====
  const qs = new URLSearchParams(location.search);
  const RUN_T = qs.get('t') || String(Date.now());   // usado para cache-busting consistente
  const STATUS = (qs.get('status') || '').toLowerCase(); // success | failure | cancelled | timeout | ''

  // ===== Refs de UI =====
  const chipExec = document.getElementById('chipExec');   // pode não existir se você removeu execId; ignore
  const chipTempo = document.getElementById('chipTempo');
  const chipStatus = document.getElementById('chipStatus');
  const listaArquivos = document.getElementById('listaArquivos');
  const listaExplicacoes = document.getElementById('listaExplicacoes');
  const areaCodecov = document.getElementById('areaCodecov');
  const kpiTestes = document.getElementById('kpiTestes');
  const kpiArquivos = document.getElementById('kpiArquivos');
  const kpiCobertura = document.getElementById('kpiCobertura');
  const statusBox = document.getElementById('statusBox');
  const btnReload = document.getElementById('btnReload');
  const btnLoading = document.getElementById('btnLoading');

  // ===== Helpers =====
  function tempoFmt(ms){
    if(!ms || ms < 1) return '—';
    let s = Math.floor(ms/1000);
    let m = Math.floor(s/60); s = s%60;
    let h = Math.floor(m/60); m = m%60;
    const parts = [];
    if (h) parts.push(h+'h'); if (m) parts.push(m+'m'); if (s) parts.push(s+'s');
    return parts.join(' ') || (ms+' ms');
  }
  function escreveStatus(msg, tipo='info'){
    statusBox.className = 'mt-6 p-3 rounded-md text-sm border ' +
      (tipo==='ok'  ? 'bg-green-100 text-green-800 border-green-200'
      : tipo==='err'? 'bg-red-100 text-red-800 border-red-200'
      :               'bg-blue-50 text-blue-800 border-blue-200');
    statusBox.textContent = msg;
  }
  function limpar(el){ while(el && el.firstChild) el.removeChild(el.firstChild); }
  function pick(arr){ return Array.isArray(arr) ? arr : []; }

  // cache-busting consistente em TODOS os fetches
  async function getJSONNoCache(url){
    const sep = url.includes('?') ? '&' : '?';
    const full = `${url}${sep}t=${encodeURIComponent(RUN_T)}&nocache=${Math.random()}`;
    const r = await fetch(full, {
      credentials:'include',
      cache:'no-store',
      headers: {
        'Cache-Control': 'no-store, no-cache, must-revalidate, max-age=0',
        'Pragma': 'no-cache',
        'Expires': '0'
      }
    });
    if (!r.ok) throw new Error(`HTTP ${r.status} em ${url}`);
    const ct = (r.headers.get('content-type')||'').toLowerCase();
    if (!ct.includes('application/json')) throw new Error(`Resposta não-JSON em ${url}`);
    return r.json();
  }

  // ===== Widgets =====
  function itemArquivo(a){
    const nome = a.nome || a.arquivo || a.path || 'arquivo';
    const link = a.link || a.download || a.url || '#';
    const preview = a.preview || a.view || link;
    const el = document.createElement('div');
    el.className = 'p-3 border rounded-md flex items-center justify-between gap-3';

    const left = document.createElement('div');
    left.className = 'flex items-center gap-2';
    const ic = document.createElement('i');
    ic.setAttribute('data-feather','file');
    ic.className = 'text-gray-400';
    const span = document.createElement('span');
    span.className = 'font-medium text-gray-800 break-all';
    span.textContent = nome;
    left.appendChild(ic); left.appendChild(span);

    const right = document.createElement('div');
    right.className = 'flex gap-2';
    const a1 = document.createElement('a'); a1.href=link; a1.target='_blank'; a1.rel='noopener'; a1.className='px-3 py-1 rounded-md border text-sm text-gray-700 bg-white hover:bg-gray-50'; a1.textContent='Baixar';
    const a2 = document.createElement('a'); a2.href=preview; a2.target='_blank'; a2.rel='noopener'; a2.className='px-3 py-1 rounded-md border text-sm text-gray-700 bg-white hover:bg-gray-50'; a2.textContent='Abrir';
    right.appendChild(a1); right.appendChild(a2);

    el.appendChild(left); el.appendChild(right);
    return el;
  }

  function itemExplicacao(e){
    const el = document.createElement('div');
    el.className = 'p-4 border rounded-md bg-white';
    const h = document.createElement('div');
    h.className = 'font-semibold text-gray-800 mb-1';
    h.textContent = e.titulo || e.title || e.arquivo || 'Explicação';
    const p = document.createElement('div');
    p.className = 'text-gray-700 text-sm whitespace-pre-wrap';
    p.textContent = e.texto || e.text || e.descricao || e.description || '';
    el.appendChild(h); el.appendChild(p);
    return el;
  }

  function renderCodecov(cc){
    limpar(areaCodecov);
    const blocks = [];
    if (cc && typeof cc === 'object') {
      if (cc.badge) blocks.push({t:'img',u:cc.badge});
      if (Array.isArray(cc.imagens)) cc.imagens.forEach(u=>blocks.push({t:'img',u}));
      if (Array.isArray(cc.images))  cc.images.forEach(u=>blocks.push({t:'img',u}));
      if (cc.coverageSvg) blocks.push({t:'img',u:cc.coverageSvg});
      if (Array.isArray(cc.iframes)) cc.iframes.forEach(u=>blocks.push({t:'ifr',u}));
      if (cc.sunburst) blocks.push({t:'ifr',u:cc.sunburst});
    }
    if (!blocks.length) {
      const d = document.createElement('div');
      d.className = 'p-4 border border-dashed border-gray-300 rounded-md bg-gray-50 text-gray-500';
      d.textContent = 'Sem dados do Codecov';
      areaCodecov.appendChild(d);
      return;
    }
    blocks.forEach(b=>{
      if (b.t==='img'){
        const w = document.createElement('div');
        w.className = 'p-2 border rounded-md bg-white';
        const img = document.createElement('img');
        // também bust no src
        const sep = b.u.includes('?') ? '&' : '?';
        img.src = `${b.u}${sep}t=${encodeURIComponent(RUN_T)}`;
        img.alt='Codecov'; img.className='w-full h-auto';
        w.appendChild(img);
        areaCodecov.appendChild(w);
      } else {
        const f = document.createElement('iframe');
        const sep = b.u.includes('?') ? '&' : '?';
        f.src = `${b.u}${sep}t=${encodeURIComponent(RUN_T)}`;
        f.className='w-full h-64 border rounded-md bg-white'; f.loading='lazy';
        areaCodecov.appendChild(f);
      }
    });
  }

  // ===== RESET TOTAL DA TELA =====
  function resetView(){
    // KPIs
    if (kpiTestes)   kpiTestes.textContent   = '0';
    if (kpiArquivos) kpiArquivos.textContent = '0';
    if (kpiCobertura)kpiCobertura.textContent= '—';

    // Badges
    if (chipTempo)  chipTempo.textContent  = '—';
    if (chipStatus) {
      chipStatus.textContent = 'status: —';
      chipStatus.className = 'badge bg-yellow-50 text-yellow-700 border border-yellow-200';
    }

    // Listas
    if (listaArquivos){
      limpar(listaArquivos);
      const d = document.createElement('div');
      d.className = 'p-4 border border-dashed border-gray-300 rounded-md bg-gray-50 text-gray-500';
      d.textContent = 'Carregando arquivos…';
      listaArquivos.appendChild(d);
    }
    if (listaExplicacoes){
      limpar(listaExplicacoes);
      const d = document.createElement('div');
      d.className = 'p-4 border border-dashed border-gray-300 rounded-md bg-gray-50 text-gray-500';
      d.textContent = 'Carregando explicações…';
      listaExplicacoes.appendChild(d);
    }
    if (areaCodecov){
      limpar(areaCodecov);
      const d = document.createElement('div');
      d.className = 'p-4 border border-dashed border-gray-300 rounded-md bg-gray-50 text-gray-500';
      d.textContent = 'Carregando Codecov…';
      areaCodecov.appendChild(d);
    }

    // Status box
    if (statusBox){
      statusBox.className = 'hidden mt-6 p-3 rounded-md text-sm';
      statusBox.textContent = '';
    }

    // Atualiza o link “Ver loading” com a nova marca
    if (btnLoading) {
      const href = new URL(btnLoading.getAttribute('href') || 'loading.html', location.href);
      href.searchParams.set('t', RUN_T);
      btnLoading.href = href.toString();
    }
  }

  // ===== Carregamentos =====
  async function carregarStatus(){
    // Se você tiver endpoint de status, chame aqui.
    // Mesmo sem endpoint, pintamos o badge com base na query ?status=...
    if (chipStatus) {
      let cls = 'badge bg-yellow-50 text-yellow-700 border border-yellow-200';
      let txt = 'status: —';
      if (STATUS) {
        const up = STATUS.toUpperCase();
        txt = 'status: ' + STATUS;
        if (up.includes('SUCCESS')) cls = 'badge bg-green-100 text-green-700 border border-green-200';
        if (up.includes('FAIL') || up.includes('CANCEL') || up.includes('TIMEOUT')) cls = 'badge bg-red-100 text-red-700 border border-red-200';
      }
      chipStatus.textContent = txt;
      chipStatus.className = cls;
    }
  }

  async function carregarResultados(){
    try{
      // ❗ Ajuste os endpoints conforme seu backend:
      // Sem execId: apenas /api/resultados com cache-busting
      const j = await getJSONNoCache('/api/resultados');

      const arquivos = j.arquivos || j.tests || j.testes || [];
      const explics  = j.explicacoes || j.explanacoes || j.explanations || [];
      const cc       = j.codecov || {};
      const totalT   = j.totalTestes || j.testsCount || arquivos.length;
      const cobertura= j.cobertura ?? cc.cobertura ?? '—';
      const dur      = j.duracaoMs ?? j.tempo ?? j.durationMs;

      if (kpiTestes)   kpiTestes.textContent   = String(totalT);
      if (kpiArquivos) kpiArquivos.textContent = String(Array.isArray(arquivos) ? arquivos.length : 0);
      if (kpiCobertura)kpiCobertura.textContent= (typeof cobertura === 'number') ? (cobertura.toFixed(2)+'%') : String(cobertura);
      if (chipTempo && dur!=null) chipTempo.textContent = tempoFmt(dur);

      // Arquivos
      if (listaArquivos){
        limpar(listaArquivos);
        const list = pick(arquivos);
        if (!list.length){
          const d = document.createElement('div');
          d.className = 'p-4 border border-dashed border-gray-300 rounded-md bg-gray-50 text-gray-500';
          d.textContent = 'Nenhum arquivo de teste localizado';
          listaArquivos.appendChild(d);
        } else {
          list.forEach(a=> listaArquivos.appendChild(itemArquivo(a)));
          feather.replace(); // re-render icons
        }
      }

      // Explicações
      if (listaExplicacoes){
        limpar(listaExplicacoes);
        const ex = pick(explics);
        if (!ex.length){
          const d = document.createElement('div');
          d.className = 'p-4 border border-dashed border-gray-300 rounded-md bg-gray-50 text-gray-500';
          d.textContent = 'Sem explicações disponíveis';
          listaExplicacoes.appendChild(d);
        } else {
          ex.forEach(e=> listaExplicacoes.appendChild(itemExplicacao(e)));
        }
      }

      // Codecov
      renderCodecov(cc);
      escreveStatus('Resultados atualizados', 'ok');
    }catch(e){
      escreveStatus('Erro ao carregar resultados: '+e.message,'err');
    }
  }

  // ===== Eventos =====
  if (btnReload) {
    btnReload.addEventListener('click', async ()=>{
      resetView();
      escreveStatus('Atualizando…');
      await carregarStatus();
      await carregarResultados();
    });
  }

  document.addEventListener('DOMContentLoaded', async ()=>{
    resetView();
    await carregarStatus();
    await carregarResultados();
  });
</script>

</body>
</html>
