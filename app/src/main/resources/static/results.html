<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Resultados • Gerador de Testes</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{--bg:#0b0b10;--card:#12121a;--muted:#9596a8;--text:#e8e8f2;--cta:#7c5cff;--cta2:#9d8bff;--ok:#2ecc71;--warn:#f39c12;--err:#e74c3c;--chip:#1a1a24}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:radial-gradient(1200px 800px at 20% -10%,#1b1633 0%,transparent 55%),radial-gradient(900px 700px at 120% 10%,#10243e 0%,transparent 50%),var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
a{color:var(--cta)}
.container{max-width:1160px;margin:0 auto;padding:28px}
.header{display:flex;gap:14px;align-items:center;justify-content:space-between;margin-bottom:20px}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--cta),var(--cta2));display:grid;place-items:center;font-weight:800;color:white;box-shadow:0 10px 22px rgba(124,92,255,.35)}
.titulo{font-size:20px;font-weight:800;letter-spacing:.3px}
.controles{display:flex;gap:10px;flex-wrap:wrap}
.btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;background:var(--chip);color:var(--text);font-weight:600;cursor:pointer;transition:transform .08s ease,opacity .2s ease}
.btn:hover{transform:translateY(-1px)}
.btn.cta{background:linear-gradient(135deg,var(--cta),var(--cta2));color:#fff}
.grid{display:grid;grid-template-columns:1fr;gap:16px}
@media(min-width:960px){.grid{grid-template-columns:1.2fr .8fr}}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.04),rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,0.06);box-shadow:0 12px 30px rgba(0,0,0,.35),inset 0 0 0 1px rgba(255,255,255,0.02);backdrop-filter:blur(8px);border-radius:16px;padding:18px}
.card h2{margin:0 0 12px 0;font-size:16px;font-weight:800;letter-spacing:.2px}
.linha{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:12px;flex-wrap:wrap}
.status{display:flex;align-items:center;gap:12px}
.ponto{width:10px;height:10px;border-radius:50%;background:var(--warn);box-shadow:0 0 12px var(--warn)}
.badges{display:flex;gap:8px;flex-wrap:wrap}
.badge{background:var(--chip);padding:6px 10px;border-radius:999px;font-size:12px}
.lista{display:flex;flex-direction:column;gap:10px;max-height:420px;overflow:auto;padding-right:4px}
.item{display:flex;gap:12px;align-items:center;justify-content:space-between;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);padding:12px;border-radius:12px}
.item span{font-weight:600;word-break:break-all}
.kpis{display:flex;gap:8px;flex-wrap:wrap}
.kpi{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);padding:10px 12px;border-radius:12px;display:flex;gap:10px;align-items:baseline}
.kpi b{font-size:18px}
.vazio{opacity:.75}
.separador{height:1px;background:rgba(255,255,255,0.08);margin:12px 0}
.explicacao{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);padding:12px;border-radius:12px}
.explicacao h3{margin:0 0 6px 0;font-size:14px}
.embed{width:100%;min-height:280px;background:rgba(255,255,255,0.02);border:1px dashed rgba(255,255,255,0.12);border-radius:12px;display:grid;place-items:center;overflow:hidden}
.iframe{width:100%;height:420px;border:0}
.rodape{opacity:.65;font-size:12px;margin-top:14px}
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="brand">
            <div class="logo">GT</div>
            <div class="titulo">Resultados do Processamento</div>
        </div>
        <div class="controles">
            <button id="btnRecarregar" class="btn">Recarregar</button>
            <a id="btnVoltar" class="btn" href="index.html">Nova análise</a>
            <a id="btnLoading" class="btn cta" href="loading.html">Ver loading</a>
        </div>
    </div>

    <div class="grid">
        <div class="card">
            <div class="linha">
                <div class="status">
                    <div class="ponto" id="ponto"></div>
                    <div id="textoStatus">Atualizando...</div>
                </div>
                <div class="badges">
                    <div class="badge" id="badgeExec">execId: —</div>
                    <div class="badge" id="badgeTempo">—</div>
                </div>
            </div>
            <div class="kpis">
                <div class="kpi"><span>Testes</span><b id="kpiTestes">0</b></div>
                <div class="kpi"><span>Arquivos</span><b id="kpiArquivos">0</b></div>
                <div class="kpi"><span>Cobertura</span><b id="kpiCobertura">—</b></div>
            </div>
            <div class="separador"></div>
            <h2>Arquivos de Teste (entrada-usuário)</h2>
            <div id="listaArquivos" class="lista vazio"></div>
        </div>

        <div class="card">
            <h2>Dashboards Codecov</h2>
            <div id="areaCodecov" class="lista">
                <div class="embed" id="placeholderCodecov">Aguardando dados do Codecov</div>
            </div>
            <div class="rodape">É possível exigir autenticação do Codecov para gráficos privados.</div>
        </div>
    </div>

    <div class="card" style="margin-top:16px">
        <h2>Explicações</h2>
        <div id="listaExplicacoes" class="lista vazio"></div>
    </div>
</div>

<script>
function qs(n){return new URLSearchParams(location.search).get(n)||""}
function el(n){return document.getElementById(n)}
function txt(n,v){el(n).textContent=v}
function chip(elem,ok){elem.style.background=ok?"#13251a":"#2a2413";elem.style.borderColor=ok?"#214a33":"#4a3d21"}
function formatoTempo(ms){if(!ms||ms<1000)return ms?ms+" ms":"—";let s=Math.floor(ms/1000);let m=Math.floor(s/60);s=s%60;let h=Math.floor(m/60);m=m%60;return (h?h+"h ":"")+(m?m+"m ":"")+(s?s+"s":"")}
function segura(v){return v==null?"":String(v)}
function urlApiResultados(exec){return "/api/resultados"+(exec?"?execId="+encodeURIComponent(exec):"")}
function urlApiStatus(exec){return "/api/process/status"+(exec?"?execId="+encodeURIComponent(exec):"")}
function criarItemArquivo(a){let d=document.createElement("div");d.className="item";let nome=document.createElement("span");nome.textContent=segura(a.nome||a.arquivo||"arquivo.java");let acoes=document.createElement("div");acoes.style.display="flex";acoes.style.gap="8px";let ver=document.createElement("a");ver.className="btn";ver.textContent="Baixar";ver.href=a.link||a.download||"#";ver.target="_blank";let abrir=document.createElement("a");abrir.className="btn";abrir.textContent="Abrir";abrir.href=a.preview||a.link||"#";abrir.target="_blank";acoes.appendChild(ver);acoes.appendChild(abrir);d.appendChild(nome);d.appendChild(acoes);return d}
function criarExplicacao(e){let d=document.createElement("div");d.className="explicacao";let h=document.createElement("h3");h.textContent=segura(e.titulo||e.arquivo||"Explicação");let p=document.createElement("div");p.innerText=segura(e.texto||e.descricao||"");d.appendChild(h);d.appendChild(p);return d}
function limpar(c){while(c.firstChild)c.removeChild(c.firstChild)}
async function carregar(){let exec=qs("execId");txt("badgeExec","execId: "+(exec||"—"));el("ponto").style.background="#f39c12";el("ponto").style.boxShadow="0 0 12px #f39c12";txt("textoStatus","Buscando resultados");try{let r=await fetch(urlApiResultados(exec),{credentials:"include"});if(!r.ok)throw new Error("falha");let j=await r.json();let ar=j.arquivos||j.tests||j.testes||[];let ex=j.explicacoes||j.explanacoes||[];let cc=j.codecov||{};txt("kpiArquivos",ar.length);txt("kpiTestes",j.totalTestes||j.testsCount||ar.length);txt("kpiCobertura",j.cobertura||cc.cobertura||"—");let la=el("listaArquivos");limpar(la);if(ar.length){la.classList.remove("vazio");ar.forEach(a=>la.appendChild(criarItemArquivo(a)))}else{la.classList.add("vazio");la.textContent="Nenhum arquivo localizado em entrada-usuário"}let le=el("listaExplicacoes");limpar(le);if(ex.length){le.classList.remove("vazio");ex.forEach(e=>le.appendChild(criarExplicacao(e)))}else{le.classList.add("vazio");le.textContent="Sem explicações disponíveis"}let ac=el("areaCodecov");limpar(ac);let emb=[];if(cc.badge)emb.push({tipo:"img",src:cc.badge});if(cc.imagens)cc.imagens.forEach(u=>emb.push({tipo:"img",src:u}));if(cc.iframes)cc.iframes.forEach(u=>emb.push({tipo:"iframe",src:u}));if(cc.coverageSvg)emb.push({tipo:"img",src:cc.coverageSvg});if(cc.sunburst)emb.push({tipo:"iframe",src:cc.sunburst});if(emb.length==0){let ph=document.createElement("div");ph.className="embed";ph.textContent="Sem dados do Codecov";ac.appendChild(ph)}else{emb.forEach(e=>{if(e.tipo==="img"){let w=document.createElement("div");w.className="embed";let i=document.createElement("img");i.src=e.src;i.alt="Codecov";i.style.maxWidth="100%";i.style.height="auto";w.appendChild(i);ac.appendChild(w)}else{let f=document.createElement("iframe");f.className="iframe";f.loading="lazy";f.src=e.src;ac.appendChild(f)}})}
el("ponto").style.background="#2ecc71";el("ponto").style.boxShadow="0 0 12px #2ecc71";txt("textoStatus","Finalizado")}
catch(e){txt("textoStatus","Erro ao carregar resultados");el("ponto").style.background="#e74c3c";el("ponto").style.boxShadow="0 0 12px #e74c3c"}}
async function verificar(){let exec=qs("execId");try{let r=await fetch(urlApiStatus(exec),{credentials:"include"});if(!r.ok)throw new Error("falha");let j=await r.json();txt("badgeTempo",formatoTempo(j.duracaoMs||j.tempo||0));if(j.estado==="FINALIZADO"||j.done){await carregar()}else{txt("textoStatus","Processando");el("ponto").style.background="#f39c12";el("ponto").style.boxShadow="0 0 12px #f39c12"}}
catch(e){}}
el("btnRecarregar").addEventListener("click",carregar)
document.addEventListener("DOMContentLoaded",async()=>{await verificar();await carregar()})
</script>
</body>
</html>
