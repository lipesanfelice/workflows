<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Processando…</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
</head>
<body class="min-h-screen bg-gray-50 flex items-center justify-center">
  <div class="w-full max-w-md mx-4">
    <div class="bg-white shadow rounded-2xl p-8 text-center">
      <i data-feather="loader" class="w-12 h-12 mx-auto mb-4 animate-spin text-blue-600"></i>
      <h1 class="text-xl font-semibold text-gray-800 mb-2">Estamos processando seu código…</h1>
      <p class="text-gray-500">Isso pode levar alguns instantes. Não feche esta página.</p>
    </div>
  </div>

<script>
feather.replace();

const STATUS_URLS = ['/api/process/status','/process/status']; // tenta nesta ordem

async function getStatus(url){
  try{
    const r = await fetch(url, { cache:'no-store', credentials:'include' });
    if(!r.ok) return null;
    const ct = (r.headers.get('content-type')||'').toLowerCase();
    if(!ct.includes('application/json')) return null;
    return await r.json(); // esperado: { running:boolean, done:boolean, error:boolean }
  }catch(_){ return null; }
}

async function poll(){
  let chosen = null;
  let backoff = 1000;

  async function loop(){
    try{
      if(!chosen){
        // escolhe o primeiro endpoint que responder
        for(const u of STATUS_URLS){
          const j = await getStatus(u);
          if(j){ chosen = u; break; }
        }
        if(!chosen){ setTimeout(loop, backoff); return; }
      }
      const j = await getStatus(chosen);
      if(!j){ setTimeout(loop, backoff = Math.min(backoff*1.5, 5000)); return; }

      if(j.done){
        const target = j.error ? 'results.html?error=1' : 'results.html';
        location.href = target;
        return;
      }
      // segue rodando
      setTimeout(loop, 1000);
    }catch(_){
      setTimeout(loop, backoff = Math.min(backoff*1.5, 5000));
    }
  }
  loop();
}

poll();
</script>
</body>
</html>
