<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Processando…</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
</head>
<body class="min-h-screen bg-gray-50 flex items-center justify-center">
  <div class="w-full max-w-md mx-4">
    <div class="bg-white shadow rounded-2xl p-8 text-center">
      <i data-feather="loader" class="w-12 h-12 mx-auto mb-4 animate-spin text-blue-600"></i>
      <h1 class="text-xl font-semibold text-gray-800 mb-2">Estamos processando seu código…</h1>
      <p class="text-gray-500">Isso pode levar alguns instantes. Não feche esta página.</p>
    </div>
    <p id="hint" class="text-center text-xs text-gray-400 mt-3"></p>
  </div>

  <script>
    feather.replace();

    const HINT = document.getElementById('hint');
    const STATUS_URLS = ['/api/process/status']; // ajuste se seu prefixo for diferente
    const POLL_MS = 1000;

    async function tryFetch(url) {
      try {
        const r = await fetch(url, { credentials: 'include' });
        if (!r.ok) return { ok:false, status:r.status };
        const ct = (r.headers.get('content-type')||'').toLowerCase();
        if (!ct.includes('application/json')) return { ok:false, status:r.status, note:'non-json' };
        const j = await r.json();
        return { ok:true, json:j };
      } catch (e) {
        return { ok:false, error:e.message };
      }
    }

    async function poll() {
      // tenta o primeiro endpoint válido
      let res = null, chosen = null;
      for (const u of STATUS_URLS) {
        res = await tryFetch(u);
        if (res.ok) { chosen = u; break; }
      }
      if (!chosen) {
        HINT.textContent = 'Não foi possível consultar o status da execução.';
        setTimeout(poll, POLL_MS);
        return;
      }

      const st = res.json || {};
      // Esperado do backend (opção B):
      // { running: boolean, done: boolean, error: boolean, status: "in_progress"|"done"|"error" }
      if (st.done === true) {
        const to = 'results.html' + (st.error ? '?error=1' : '');
        window.location.href = to;
        return;
      }

      // caso ainda esteja rodando ou sem sinal claro, segue polling
      HINT.textContent = st.status ? `status: ${st.status}` : '';
      setTimeout(poll, POLL_MS);
    }

    poll();
  </script>
</body>
</html>
