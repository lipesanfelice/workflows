<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Processando…</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
</head>
<body class="min-h-screen bg-gray-50 flex items-center justify-center">
  <div class="w-full max-w-md mx-4">
    <div class="bg-white shadow rounded-2xl p-8 text-center">
      <div class="flex items-center justify-center mb-4">
        <i data-feather="loader" class="w-10 h-10 animate-spin text-blue-600"></i>
      </div>
      <h1 class="text-xl font-semibold text-gray-800 mb-2">Estamos processando seu código…</h1>
      <p id="msg" class="text-gray-500">Aguarde enquanto a pipeline executa.</p>

      <div id="errBox" class="hidden mt-4 text-sm text-red-700 bg-red-50 border border-red-200 rounded p-3 text-left"></div>

      <div class="mt-6">
        <a href="index.html" class="text-sm text-gray-500 hover:underline">Voltar</a>
      </div>
    </div>
  </div>

<script>
feather.replace();
let dono='lipesanfelice',repo='workflows',ramo='main';
const qs=new URLSearchParams(location.search);
dono=qs.get('owner')||dono;repo=qs.get('repo')||repo;ramo=qs.get('branch')||ramo;
const token=qs.get('ght')||sessionStorage.getItem('ght')||'';
const runParam=qs.get('run_id')||'';
const msgEl=document.getElementById('msg');
const errBox=document.getElementById('errBox');
const timeoutMs=20*60*1000;
const intervalo=2000;
const marcadorPath='app/entrada-usuario/done.json';

function cabecalhos(){const h={'Cache-Control':'no-store'};if(token){h.Authorization=`Bearer ${token}`;h['X-GitHub-Api-Version']='2022-11-28'}return h}
function fmtDur(ms){if(!ms||ms<1)return'—';let s=Math.floor(ms/1000),m=Math.floor(s/60);s%=60;let h=Math.floor(m/60);m%=60;const p=[];if(h)p.push(h+'h');if(m)p.push(m+'m');if(s)p.push(s+'s');return p.join(' ')}
function irResultados(status){location.href=`results.html?status=${encodeURIComponent(status)}&owner=${encodeURIComponent(dono)}&repo=${encodeURIComponent(repo)}&branch=${encodeURIComponent(ramo)}`}

async function runPorId(id){const u=`https://api.github.com/repos/${dono}/${repo}/actions/runs/${id}`;const r=await fetch(u,{cache:'no-store',headers:cabecalhos()});if(!r.ok)return {erro:r.status};return {ok:true,dados:await r.json()}}
async function ultimoRunDaBranch(){const u=`https://api.github.com/repos/${dono}/${repo}/actions/runs?branch=${encodeURIComponent(ramo)}&per_page=1`;const r=await fetch(u,{cache:'no-store',headers:cabecalhos()});if(!r.ok)return {erro:r.status};const j=await r.json();const it=(j.workflow_runs||[])[0];if(!it)return {vazio:true};return {ok:true,dados:it}}
async function lerMarcador(){const u=`https://raw.githubusercontent.com/${dono}/${repo}/${ramo}/${marcadorPath}?t=${Date.now()}`;const r=await fetch(u,{cache:'no-store'});if(r.status===404)return {nao:1};if(!r.ok)return {erro:r.status};try{const j=JSON.parse(await r.text());return {ok:true,j}}catch{return {bad:1}}}

let inicio=null,modo='acoes',backoff=0;
async function ciclo(){
  try{
    let runInfo=null;
    if(modo==='acoes'){
      if(runParam){
        const r=await runPorId(runParam);
        if(r.erro){if(r.erro===403){modo='marcador'}else throw new Error('HTTP '+r.erro)}
        else runInfo=r.dados;
      }else{
        const r=await ultimoRunDaBranch();
        if(r.erro){if(r.erro===403){modo='marcador'}else throw new Error('HTTP '+r.erro)}
        else if(r.vazio){modo='marcador'}
        else runInfo=r.dados;
      }
      if(runInfo){
        const st=runInfo.status,conc=runInfo.conclusion;
        const t0=runInfo.run_started_at?new Date(runInfo.run_started_at).getTime():null;
        const tf=runInfo.updated_at?new Date(runInfo.updated_at).getTime():null;
        if(!inicio) inicio=t0||Date.now();
        const agora=Date.now();
        if(st==='queued'){msgEl.textContent=`Em fila… (${fmtDur(agora-inicio)})`}
        else if(st==='in_progress'){msgEl.textContent=`Executando… (${fmtDur(agora-inicio)})`}
        else if(st==='completed'){
          const status=(conc||'').toLowerCase();
          msgEl.textContent=`Concluído em ${fmtDur((tf||agora)-(t0||agora))}`;
          return irResultados(status||'success');
        }else{msgEl.textContent=`Aguardando… (${fmtDur(agora-(inicio||agora))})`}
      }
    }else{
      const m=await lerMarcador();
      if(m.ok&&m.j&&m.j.done===true){return irResultados(String(m.j.status||'success').toLowerCase())}
      if(m.erro===403){backoff=Math.min((backoff||1000)*2,10000)}
      msgEl.textContent='Aguardando finalização…'
    }
    setTimeout(ciclo, (modo==='marcador'?(2000+(backoff||0)):intervalo));
  }catch(e){
    errBox.classList.remove('hidden');errBox.textContent='Erro: '+e.message;
    setTimeout(ciclo,3000);
  }
}
msgEl.textContent='Preparando…';
setTimeout(()=>{irResultados('timeout')},timeoutMs);
ciclo();
</script>

</body>
</html>
