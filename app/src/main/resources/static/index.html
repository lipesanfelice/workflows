<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Code Analysis Platform</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <style>
    .code-editor{min-height:300px;font-family:'Courier New',monospace}
    .dropzone{border:2px dashed #cbd5e0;transition:all .3s ease}
    .dropzone.active{border-color:#4299e1;background-color:#ebf8ff}
    .progress-bar{transition:width .5s ease}
    pre.json{white-space:pre-wrap;word-break:break-word}
  </style>
</head>
<body class="bg-gray-50">
<div id="app" class="min-h-screen flex flex-col">
  <nav class="bg-blue-600 text-white shadow-lg">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center space-x-2">
        <i data-feather="code"></i>
        <span class="font-bold text-xl">CodeAnalyzer</span>
      </div>
      <div class="hidden md:flex space-x-6">
        <a class="hover:text-blue-200">Home</a>
        <a class="hover:text-blue-200" href="results.html">Resultados</a>
      </div>
      <button class="md:hidden">
        <i data-feather="menu"></i>
      </button>
    </div>
  </nav>

  <main class="flex-grow container mx-auto px-4 py-8">
    <section id="upload-section" class="mb-8">
      <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Analise seu código Java</h1>
        <p class="text-gray-600 max-w-2xl mx-auto">
          Envie seu código colando, via arquivo .java ou um projeto .zip. Salvamos primeiro em <b>entrada-usuario</b> (ou <b>entrada</b>) e depois processamos a pipeline.
        </p>
      </div>

      <div class="grid md:grid-cols-3 gap-6">
        <div class="bg-white rounded-lg shadow-md overflow-hidden" data-aos="fade-up">
          <div class="bg-blue-50 px-4 py-3 border-b border-blue-100">
            <h3 class="font-semibold text-blue-700 flex items-center">
              <i data-feather="clipboard" class="mr-2"></i> Colar código
            </h3>
          </div>
          <div class="p-4">
            <textarea id="code-input" class="code-editor w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Cole seu código Java aqui...">public class Exemplo {
  public static void main(String[] args) {
    System.out.println("Hello World!");
  }
}</textarea>
            <button id="submit-code" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-300 flex items-center justify-center">
              <i data-feather="send" class="mr-2"></i> Analisar Código
            </button>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow-md overflow-hidden" data-aos="fade-up" data-aos-delay="100">
          <div class="bg-blue-50 px-4 py-3 border-b border-blue-100">
            <h3 class="font-semibold text-blue-700 flex items-center">
              <i data-feather="upload" class="mr-2"></i> Enviar arquivo .java
            </h3>
          </div>
          <div class="p-4">
            <div id="file-dropzone" class="dropzone p-8 text-center rounded-md cursor-pointer">
              <i data-feather="file" class="w-12 h-12 mx-auto text-gray-400 mb-3"></i>
              <p class="text-gray-500 mb-2">Arraste e solte seu .java aqui</p>
              <p class="text-sm text-gray-400 mb-4">ou</p>
              <label for="file-upload" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-300 cursor-pointer inline-block">
                Selecionar arquivo
              </label>
              <input id="file-upload" type="file" accept=".java" class="hidden">
            </div>
            <div id="file-info" class="mt-3 hidden">
              <p class="text-sm text-gray-600"><span id="file-name"></span> <span id="file-size" class="text-gray-400"></span></p>
            </div>
            <button id="submit-file" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-300 flex items-center justify-center hidden">
              <i data-feather="send" class="mr-2"></i> Analisar Arquivo
            </button>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow-md overflow-hidden" data-aos="fade-up" data-aos-delay="200">
          <div class="bg-blue-50 px-4 py-3 border-b border-blue-100">
            <h3 class="font-semibold text-blue-700 flex items-center">
              <i data-feather="archive" class="mr-2"></i> Enviar projeto .zip
            </h3>
          </div>
          <div class="p-4">
            <div id="zip-dropzone" class="dropzone p-8 text-center rounded-md cursor-pointer">
              <i data-feather="folder" class="w-12 h-12 mx-auto text-gray-400 mb-3"></i>
              <p class="text-gray-500 mb-2">Arraste e solte seu .zip aqui</p>
              <p class="text-sm text-gray-400 mb-4">ou</p>
              <label for="zip-upload" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-300 cursor-pointer inline-block">
                Selecionar ZIP
              </label>
              <input id="zip-upload" type="file" accept=".zip" class="hidden">
            </div>
            <div id="zip-info" class="mt-3 hidden">
              <p class="text-sm text-gray-600"><span id="zip-name"></span> <span id="zip-size" class="text-gray-400"></span></p>
            </div>
            <button id="submit-zip" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-300 flex items-center justify-center hidden">
              <i data-feather="send" class="mr-2"></i> Analisar ZIP
            </button>
          </div>
        </div>
      </div>
    </section>

    <div id="status" class="hidden rounded-md p-3 text-sm"></div>

    <section class="bg-white rounded-lg shadow-md p-4">
      <h2 class="text-lg font-semibold mb-2 flex items-center text-gray-800">
        <i data-feather="activity" class="mr-2"></i>
        Resultado (debug)
      </h2>
      <pre id="result" class="json text-gray-800 text-sm"></pre>
    </section>
  </main>

  <footer class="bg-gray-800 text-white py-6">
    <div class="container mx-auto px-4 text-center">
      <p>&copy; 2023 CodeAnalyzer. Todos os direitos reservados.</p>
    </div>
  </footer>
</div>

<div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4" data-aos="zoom-in">
    <div class="text-center">
      <div class="w-16 h-16 mx-auto mb-4">
        <i data-feather="loader" class="animate-spin w-full h-full text-blue-600"></i>
      </div>
      <h3 class="text-xl font-semibold text-gray-800 mb-2">Processando…</h3>
      <p class="text-gray-600 mb-4">Isso pode levar alguns instantes.</p>
      <div class="w-full bg-gray-200 rounded-full h-2.5">
        <div id="progress-bar" class="progress-bar bg-blue-600 h-2.5 rounded-full" style="width:0%"></div>
      </div>
      <p id="progress-text" class="text-sm text-gray-500 mt-2">Iniciando…</p>
    </div>
  </div>
</div>

<script>
  const DONO_PADRAO='lipesanfelice';
  const REPO_PADRAO='workflows';
  const RAMO_PADRAO='main';
  const TOKEN_GH=sessionStorage.getItem('ght')||'';
</script>

<script>
  AOS.init();
  feather.replace();
  const statusDiv=document.getElementById('status');
  const resultPre=document.getElementById('result');
  const loadingModal=document.getElementById('loading-modal');
  const progressBar=document.getElementById('progress-bar');
  const progressText=document.getElementById('progress-text');
  function mostrarStatus(msg,tipo='success'){
    statusDiv.classList.remove('hidden','bg-green-100','text-green-800','border','border-green-200','bg-red-100','text-red-800','border-red-200');
    if(tipo==='success')statusDiv.classList.add('bg-green-100','text-green-800','border','border-green-200');else statusDiv.classList.add('bg-red-100','text-red-800','border-red-200');
    statusDiv.textContent=msg
  }
  function mostrarResultado(obj){
    try{resultPre.textContent=JSON.stringify(obj,null,2)}catch(e){resultPre.textContent=String(obj??'')}
  }
  function iniciarLoading(txt){loadingModal.classList.remove('hidden');progressBar.style.width='0%';progressText.textContent=txt||'Iniciando…'}
  function progresso(p,t){progressBar.style.width=`${Math.max(0,Math.min(100,p))}%`;if(t)progressText.textContent=t}
  function pararLoading(){loadingModal.classList.add('hidden')}
</script>

<script>
  const fileUpload=document.getElementById('file-upload');
  const fileDropzone=document.getElementById('file-dropzone');
  const fileInfo=document.getElementById('file-info');
  const fileName=document.getElementById('file-name');
  const fileSize=document.getElementById('file-size');
  const submitFileBtn=document.getElementById('submit-file');
  const zipUpload=document.getElementById('zip-upload');
  const zipDropzone=document.getElementById('zip-dropzone');
  const zipInfo=document.getElementById('zip-info');
  const zipName=document.getElementById('zip-name');
  const zipSize=document.getElementById('zip-size');
  const submitZipBtn=document.getElementById('submit-zip');
  ['dragenter','dragover'].forEach(ev=>{[fileDropzone,zipDropzone].forEach(zone=>zone.addEventListener(ev,e=>{e.preventDefault();zone.classList.add('active')}))});
  ['dragleave','drop'].forEach(ev=>{[fileDropzone,zipDropzone].forEach(zone=>zone.addEventListener(ev,e=>{e.preventDefault();zone.classList.remove('active')}))});
  fileDropzone.addEventListener('drop',e=>{const f=e.dataTransfer.files?.[0];if(f&&f.name.endsWith('.java'))selecionarArquivo(f,'java')});
  zipDropzone.addEventListener('drop',e=>{const f=e.dataTransfer.files?.[0];if(f&&f.name.endsWith('.zip'))selecionarArquivo(f,'zip')});
  fileUpload.addEventListener('change',()=>{if(fileUpload.files.length)selecionarArquivo(fileUpload.files[0],'java')});
  zipUpload.addEventListener('change',()=>{if(zipUpload.files.length)selecionarArquivo(zipUpload.files[0],'zip')});
  function selecionarArquivo(arq,tipo){
    const java=tipo==='java';
    const info=java?fileInfo:zipInfo;
    const nome=java?fileName:zipName;
    const tam=java?fileSize:zipSize;
    const btn=java?submitFileBtn:submitZipBtn;
    if(nome)nome.textContent=arq.name;
    if(tam)tam.textContent=`(${(arq.size/1024).toFixed(2)} KB)`;
    if(info)info.classList.remove('hidden');
    if(btn)btn.classList.remove('hidden');
    if(java)window.arquivoJavaSelecionado=arq;else window.zipSelecionado=arq
  }
</script>

<script>
  async function arquivoParaBase64(arquivo){
    return new Promise((resolve,reject)=>{const r=new FileReader();r.onload=()=>resolve(r.result.split(',')[1]);r.onerror=reject;r.readAsDataURL(arquivo)})
  }
  const ENTRADA_BASES=['/entrada-usuario','/entrada'];
  async function postComFallback(subpath,makeBody,makeHeaders){
    let ultimo;
    for(const base of ENTRADA_BASES){
      const url=base.replace(/\/+$/,'')+'/'+subpath.replace(/^\/+/,'');

      try{
        const body=makeBody();
        const headers=makeHeaders?.()||undefined;
        const resp=await fetch(url,{method:'POST',body,headers,credentials:'include'});
        if(resp.ok){const text=await resp.text();mostrarResultado({salvoEm:url,mensagem:text});return{ok:true,msg:text,baseUsada:base}}
        if(![404,405].includes(resp.status)){const text=await resp.text().catch(()=> '');return{ok:false,msg:text||(`HTTP ${resp.status}`),baseUsada:base}}
        ultimo=resp
      }catch(e){ultimo=e}
    }
    return{ok:false,msg:`Falha ao salvar (tentado: ${ENTRADA_BASES.join(', ')}). Último erro: ${ultimo?.status||ultimo?.message||ultimo}`,baseUsada:null}
  }
  async function salvarCodigoGithub(codigo){return postComFallback('codigo',()=>new URLSearchParams({codigo}),()=>({'Content-Type':'application/x-www-form-urlencoded'}))}
  async function salvarArquivoGithub(file){return postComFallback('arquivo',()=>{const fd=new FormData();fd.append('arquivo',file);return fd})}
  async function salvarZipGithub(file){return postComFallback('projeto',()=>{const fd=new FormData();fd.append('projetoZip',file);return fd})}
</script>

<script>
  async function enviarParaLoading(tipo,payload,meta){
    const dono=(meta&&meta.dono)||DONO_PADRAO;
    const repo=(meta&&meta.repo)||REPO_PADRAO;
    const ramo=(meta&&meta.ramo)||RAMO_PADRAO;
    const ght=(meta&&meta.ght)||TOKEN_GH||'';
    let runId='';
    try{
      const r=await fetch('/api/process/start',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({tipo,payload})});
      if(r.ok){const j=await r.json().catch(()=>({}));runId=j.runId||j.run_id||j.id||''}
    }catch(_){}
    const p=new URLSearchParams();
    p.set('owner',dono);p.set('repo',repo);p.set('branch',ramo);
    if(ght)p.set('ght',ght);
    if(runId)p.set('run_id',runId);
    sessionStorage.setItem('pendingJob',JSON.stringify({tipo,quando:Date.now(),payload}));
    await fetch('/api/process/reset',{method:'POST'}).catch(()=>{});
    location.href='loading.html?'+p.toString()
  }
</script>

<script>
  document.getElementById('submit-code').addEventListener('click',async()=>{
    const codigo=(document.getElementById('code-input').value||'').trim();
    if(!codigo){mostrarStatus('Por favor, insira algum código Java.','error');return}
    iniciarLoading('Salvando entrada…');progresso(25,'Enviando para a entrada…');
    try{
      const res=await salvarCodigoGithub(codigo);
      mostrarStatus(res.msg,res.ok?'success':'error');
      if(!res.ok){progresso(0,'');return}
      progresso(55,'Preparando processamento…');
      await enviarParaLoading('codigo',{codigo},{dono:DONO_PADRAO,repo:REPO_PADRAO,ramo:RAMO_PADRAO,ght:TOKEN_GH})
    }catch(e){mostrarStatus('Erro ao salvar: '+e.message,'error')}
    finally{setTimeout(pararLoading,200)}
  });

  document.getElementById('submit-file').addEventListener('click',async()=>{
    const f=window.arquivoJavaSelecionado;
    if(!f){mostrarStatus('Selecione um arquivo .java.','error');return}
    iniciarLoading('Salvando entrada…');progresso(25,'Enviando arquivo para a entrada…');
    try{
      const res=await salvarArquivoGithub(f);
      mostrarStatus(res.msg,res.ok?'success':'error');
      if(!res.ok){progresso(0,'');return}
      progresso(55,'Preparando processamento…');
      const b64=await arquivoParaBase64(f);
      await enviarParaLoading('arquivo',{nome:f.name,mime:f.type||'text/x-java',base64:b64},{dono:DONO_PADRAO,repo:REPO_PADRAO,ramo:RAMO_PADRAO,ght:TOKEN_GH})
    }catch(e){mostrarStatus('Erro ao salvar: '+e.message,'error')}
    finally{setTimeout(pararLoading,200)}
  });

  document.getElementById('submit-zip').addEventListener('click',async()=>{
    const f=window.zipSelecionado;
    if(!f){mostrarStatus('Selecione um arquivo .zip.','error');return}
    iniciarLoading('Salvando entrada…');progresso(25,'Enviando ZIP para a entrada…');
    try{
      const res=await salvarZipGithub(f);
      mostrarStatus(res.msg,res.ok?'success':'error');
      if(!res.ok){progresso(0,'');return}
      progresso(55,'Preparando processamento…');
      const b64=await arquivoParaBase64(f);
      await enviarParaLoading('zip',{nome:f.name,mime:f.type||'application/zip',base64:b64},{dono:DONO_PADRAO,repo:REPO_PADRAO,ramo:RAMO_PADRAO,ght:TOKEN_GH})
    }catch(e){mostrarStatus('Erro ao salvar: '+e.message,'error')}
    finally{setTimeout(pararLoading,200)}
  });
</script>
</body>
</html>
